version: '3.8'

services:
  qdrant:
    image: qdrant/qdrant:latest
    container_name: ai-service-qdrant-test
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_test_storage:/qdrant/storage
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:6333/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  ai-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ai-service-test
    ports:
      - "8000:8000"
    environment:
      # Vector DB configuration
      - VECTOR_DB_TYPE=qdrant
      - VECTOR_DB_HOST=qdrant
      - VECTOR_DB_PORT=6333
      
      # File storage configuration
      - FILE_STORAGE_TYPE=local
      - FILE_STORAGE_BASE_PATH=/app/knowledge
      
      # Agent policies path
      - AGENT_POLICIES_PATH=/app/agents/policies
      # Routing policies path
      - ROUTING_POLICIES_PATH=/app/routing/policies
      # Resilience policies path
      - RESILIENCE_POLICIES_PATH=/app/resilience/policies
      # Cost control policies path
      - COST_CONTROL_POLICIES_PATH=/app/cost_control/policies
      # Caching policies path
      - CACHING_POLICIES_PATH=/app/caching/policies
      # Security policies path
      - SECURITY_POLICIES_PATH=/app/security/policies
      # Quality policies path
      - QUALITY_POLICIES_PATH=/app/quality/policies
      # Feature policies path
      - FEATURE_POLICIES_PATH=/app/features/policies
      
      # API Keys - set these from your .env file
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CIPHER_API_KEY=${CIPHER_API_KEY}
      - XAI_API_KEY=${XAI_API_KEY}
      - MANUS_API_KEY=${MANUS_API_KEY}
      
      # Service config
      - ENV=development
      - LOG_LEVEL=info
      - CORS_ENABLED=true
      - CORS_ALLOWED_ORIGINS=*
      
      # Tracing (optional)
      - OTLP_ENDPOINT=http://jaeger:4318
    volumes:
      # Mount .env file if it exists
      - ./.env:/app/.env:ro
      # Agent policies
      - ./agents/policies:/app/agents/policies:ro
      # Routing policies
      - ./routing/policies:/app/routing/policies:ro
      # Resilience policies
      - ./resilience/policies:/app/resilience/policies:ro
      # Cost control policies
      - ./cost_control/policies:/app/cost_control/policies:ro
      # Caching policies
      - ./caching/policies:/app/caching/policies:ro
      # Security policies
      - ./security/policies:/app/security/policies:ro
      # Quality policies
      - ./quality/policies:/app/quality/policies:ro
      # Feature policies
      - ./features/policies:/app/features/policies:ro
      # Knowledge base documents
      - ./knowledge:/app/knowledge:ro
    depends_on:
      qdrant:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

volumes:
  qdrant_test_storage:
